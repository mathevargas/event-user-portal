<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Finalizar Cadastro</title>
    <link rel="stylesheet" href="../assets/css/style.css">
    <link rel="manifest" href="../manifest.webmanifest">

    <script defer src="../assets/js/config.js"></script>
    <script defer src="../assets/js/auth.js"></script>
    <script src="../assets/js/pwa.js"></script>
</head>
<body>

<header class="header">
    <div class="logo">Portal de Eventos</div>
    <nav class="nav"></nav>
</header>

<div class="form-container">
    <h2>Finalizar Cadastro</h2>

    <div class="form-group">
        <label>Email</label>
        <input id="email" disabled>
    </div>

    <div class="form-group">
        <label>Nome</label>
        <input id="nome" placeholder="Seu nome completo">
    </div>

    <div class="form-group">
        <label>Nova senha</label>
        <input id="senha" type="password" placeholder="••••••••">
    </div>

    <div class="form-group">
        <label>Confirmar senha</label>
        <input id="senha2" type="password" placeholder="••••••••">
    </div>

    <button id="btnSalvar" type="button" class="btn-full">Salvar e entrar</button>
</div>

<footer class="footer">
    © 2025 Sistema de Eventos
</footer>

<script>
const emailParam = new URLSearchParams(window.location.search).get("email");
document.getElementById("email").value = emailParam ?? "";

async function completarCadastro(email, nome, senha) {
  const r1 = await fetch(`${CONFIG.AUTH_API}/usuarios/por-email?email=${encodeURIComponent(email)}&t=${Date.now()}`, { cache: "no-store" });
  if (!r1.ok) {
    console.error("❌ /usuarios/por-email falhou:", r1.status, await r1.text().catch(()=> ""));
    return null;
  }
  const u = await r1.json(); // {id,nome,email}
  if (!u?.id) return null;

  const r2 = await fetch(`${CONFIG.AUTH_API}/usuarios/${u.id}/completar?t=${Date.now()}`, {
    method: "PATCH",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ nome, senha })
  });

  if (!r2.ok) {
    console.error("❌ PATCH completar falhou:", r2.status, await r2.text().catch(()=> ""));
    return null;
  }

  if (typeof login === "function") {
    return await login(email, senha);
  }
  return true;
}

document.getElementById("btnSalvar").addEventListener("click", async (e) => {
  e.preventDefault();

  const nomeVal = document.getElementById("nome").value.trim();
  const s1 = document.getElementById("senha").value.trim();
  const s2 = document.getElementById("senha2").value.trim();

  if (!emailParam) return alert("Email inválido.");
  if (!nomeVal || !s1 || !s2) return alert("Preencha todos os campos.");
  if (s1 !== s2) return alert("As senhas não coincidem.");

  const resp = await completarCadastro(emailParam, nomeVal, s1);
  if (!resp) return alert("Erro ao completar cadastro.");

  window.location.href = "home.html";
});
</script>

</body>
</html>
